<!DOCTYPE html>
<html lang="zh-MY">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç½—é‡ŒæŠ˜æ—§è®¡ç®—å™¨ - A4 é»‘ç™½æ‰“å°ç‰ˆ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        /* =========================================
           1. ç½‘é¡µç«¯æ ·å¼ (ä¿æŒå½©è‰²ï¼Œå¥½çœ‹)
           ========================================= */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #eef2f7;
            padding: 20px;
            margin: 0;
            color: #333;
        }

        #report-wrapper {
            display: flex;
            justify-content: center;
        }

        #report-container {
            background-color: #fff;
            width: 100%;
            max-width: 800px;
            padding: 30px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            border-radius: 8px;
            box-sizing: border-box;
        }

        h1 {
            text-align: center;
            color: #2c3e50; /* å½©è‰²æ ‡é¢˜ */
            margin: 0 0 10px 0;
            font-size: 22px;
            border-bottom: 2px solid #3498db; /* å½©è‰²çº¿æ¡ */
            padding-bottom: 10px;
        }

        .subtitle {
            text-align: center;
            color: #7f8c8d;
            font-size: 13px;
            margin-bottom: 20px;
        }

        .input-section {
            display: flex;
            justify-content: space-between;
            gap: 15px;
            margin-bottom: 20px;
        }

        .vehicle-card {
            flex: 1;
            background: #f8f9fa;
            padding: 12px;
            border: 1px solid #e9ecef;
            border-radius: 6px;
        }

        .vehicle-card h3 {
            margin: 0 0 10px 0;
            font-size: 15px;
            color: #2980b9; /* å½©è‰²å°æ ‡é¢˜ */
            border-bottom: 1px solid #dee2e6;
            padding-bottom: 5px;
        }

        .form-group {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
        }

        .form-group label {
            font-size: 12px;
            font-weight: 600;
        }

        .form-group input {
            width: 80px;
            padding: 3px;
            text-align: right;
            border: 1px solid #ced4da;
            border-radius: 3px;
            font-size: 12px;
        }

        .section-total {
            margin-top: 8px;
            padding-top: 5px;
            border-top: 1px dashed #adb5bd;
            text-align: right;
        }
        
        .section-total span { font-size: 11px; color: #6c757d; }
        .section-total div { font-size: 14px; font-weight: bold; color: #27ae60; /* å½©è‰²é‡‘é¢ */ }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            font-size: 11px;
        }

        th, td {
            border: 1px solid #dee2e6;
            padding: 5px;
            text-align: right;
        }

        th {
            background-color: #3498db; /* è“è‰²è¡¨å¤´ */
            color: white;
            text-align: center;
            font-weight: 600;
        }

        td:first-child { text-align: center; }
        .current-year-row { background-color: #fff3cd; font-weight: bold; /* é»„è‰²é«˜äº® */ }

        .controls { text-align: center; margin-bottom: 20px; }
        .btn-pdf {
            background-color: #e74c3c;
            color: white;
            border: none;
            padding: 10px 20px;
            font-size: 15px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
        }

        /* =========================================
           2. PDF ä¸“ç”¨æ ·å¼ (é»‘ç™½ + ä¸¥æ ¼å°ºå¯¸)
           ========================================= */
        .pdf-mode {
            /* å°ºå¯¸æ§åˆ¶ */
            width: 700px !important;
            max-width: 700px !important;
            min-width: 700px !important;
            padding: 0 !important;
            margin: 0 !important;
            box-shadow: none !important;
            border: none !important;
            
            /* --- é»‘ç™½åŒ–æ ¸å¿ƒä»£ç  --- */
            background-color: #fff !important;
            color: #000 !important; /* å¼ºåˆ¶æ‰€æœ‰æ–‡å­—å˜é»‘ */
            filter: grayscale(100%); /* ç»ˆæä¿é™©ï¼šå»è‰²æ»¤é•œ */
        }

        /* å¼ºåˆ¶è¾“å…¥æ¡†å˜æˆçº¯é»‘æ–‡å­— */
        .pdf-mode input {
            border: none !important;
            background: transparent !important;
            padding: 0 !important;
            width: auto !important;
            font-weight: bold;
            text-align: right;
            color: #000 !important; 
        }

        /* å¸ƒå±€å¾®è°ƒ */
        .pdf-mode .input-section { gap: 10px !important; margin-bottom: 10px !important; }
        
        /* å¡ç‰‡å»è‰² */
        .pdf-mode .vehicle-card {
            padding: 8px !important;
            border: 1px solid #000 !important; /* é»‘è‰²è¾¹æ¡† */
            background-color: #fff !important; /* å»æ‰ç°è‰²èƒŒæ™¯ */
        }

        .pdf-mode h1, .pdf-mode h3, .pdf-mode .subtitle {
            color: #000 !important;
            border-color: #000 !important;
        }

        .pdf-mode .section-total div {
            color: #000 !important; /* ç»¿è‰²æ•°å­—å˜é»‘ */
        }

        /* è¡¨æ ¼å»è‰² */
        .pdf-mode table {
            font-size: 10px !important;
            border-color: #000 !important;
        }

        .pdf-mode th {
            background-color: #fff !important; /* å»æ‰è“è‰²èƒŒæ™¯ */
            color: #000 !important; /* ç™½å­—å˜é»‘å­— */
            border: 1px solid #000 !important; /* é»‘è‰²è¾¹æ¡† */
            border-bottom: 2px solid #000 !important; /* è¡¨å¤´åŠ ç²—çº¿ */
        }
        
        .pdf-mode td {
            border: 1px solid #000 !important;
            color: #000 !important;
        }

        /* é«˜äº®è¡Œå¤„ç†ï¼šå»æ‰é»„è‰²èƒŒæ™¯ï¼Œæ”¹ä¸ºåŠ ç²—è¾¹æ¡†ï¼Œæ–¹ä¾¿é»‘ç™½æ‰“å° */
        .pdf-mode .current-year-row {
            background-color: #fff !important; 
            font-weight: 900 !important; /* å­—ä½“æ›´ç²— */
            outline: 2px solid #000 !important; /* å¤–æ¡†åŠ ç²— */
        }
    </style>
</head>
<body>

<div class="controls">
    <button class="btn-pdf" onclick="exportPDF()">ğŸ“„ ä¸‹è½½é»‘ç™½ PDF (A4)</button>
</div>

<div id="report-wrapper">
    <div id="report-container">
        <h1>è½¦è¾†æŠ˜æ—§æŠ¥è¡¨</h1>
        <div class="subtitle">è®¡ç®—æ–¹æ³•: 20% ä½™é¢é€’å‡æ³• (Reducing Balance)</div>

        <div class="input-section">
            <!-- è½¦å¤´ -->
            <div class="vehicle-card">
                <h3>1. è½¦å¤´ (Head)</h3>
                <div class="form-group">
                    <label>è½¦ç‰Œ:</label>
                    <input type="text" id="headPlate" value="VAA 1234" oninput="calculate()">
                </div>
                <div class="form-group">
                    <label>åŸä»· (RM):</label>
                    <input type="number" id="headCost" value="100000" oninput="calculate()">
                </div>
                <div class="form-group">
                    <label>å¹´ä»½:</label>
                    <input type="number" id="headYear" value="2020" oninput="calculate()">
                </div>
                <div class="section-total">
                    <span>ä»Šå¹´å‡€å€¼</span>
                    <div id="head-current-val">RM 0.00</div>
                </div>
            </div>

            <!-- è½¦å°¾ -->
            <div class="vehicle-card">
                <h3>2. è½¦å°¾ (Tail)</h3>
                <div class="form-group">
                    <label>è½¦ç‰Œ:</label>
                    <input type="text" id="tailPlate" value="T 8888" oninput="calculate()">
                </div>
                <div class="form-group">
                    <label>åŸä»· (RM):</label>
                    <input type="number" id="tailCost" value="50000" oninput="calculate()">
                </div>
                <div class="form-group">
                    <label>å¹´ä»½:</label>
                    <input type="number" id="tailYear" value="2022" oninput="calculate()">
                </div>
                <div class="section-total">
                    <span>ä»Šå¹´å‡€å€¼</span>
                    <div id="tail-current-val">RM 0.00</div>
                </div>
            </div>
        </div>

        <!-- è¡¨æ ¼ -->
        <table>
            <thead>
                <tr>
                    <th width="10%">å¹´ä»½</th>
                    <th width="18%">è½¦å¤´å‡€å€¼</th>
                    <th width="18%">è½¦å°¾å‡€å€¼</th>
                    <th width="18%">åˆè®¡å‡€å€¼</th>
                    <th width="18%">å¹´æŠ˜æ—§</th>
                    <th width="18%">æœˆæŠ˜æ—§</th>
                </tr>
            </thead>
            <tbody id="tableBody"></tbody>
        </table>
    </div>
</div>

<script>
    function formatRM(num) {
        if (num === 0) return "-";
        return new Intl.NumberFormat('ms-MY', { minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(num);
    }

    function calculate() {
        let headCost = parseFloat(document.getElementById('headCost').value) || 0;
        let headYear = parseInt(document.getElementById('headYear').value);
        let tailCost = parseFloat(document.getElementById('tailCost').value) || 0;
        let tailYear = parseInt(document.getElementById('tailYear').value);

        const currentYear = new Date().getFullYear();
        let startYear = currentYear;
        if (!isNaN(headYear) && !isNaN(tailYear)) startYear = Math.min(headYear, tailYear);
        else if (!isNaN(headYear)) startYear = headYear;
        else if (!isNaN(tailYear)) startYear = tailYear;

        if (startYear < 1990) startYear = 1990; 
        if (startYear > 2100) startYear = currentYear;

        const yearsToShow = 15; 
        const rate = 0.20; 

        let tableHtml = '';
        let currHeadNBV = headCost;
        let currTailNBV = tailCost;
        let currentYearHeadVal = 0;
        let currentYearTailVal = 0;

        for (let i = 0; i < yearsToShow; i++) {
            let year = startYear + i;
            
            // Head Calculation
            let headDisplay = 0, headDepr = 0;
            if (!isNaN(headYear) && year >= headYear) {
                if (year === headYear) {
                    headDepr = headCost * rate;
                    headDisplay = headCost;
                    currHeadNBV = headCost - headDepr;
                } else {
                    headDisplay = currHeadNBV;
                    headDepr = currHeadNBV * rate;
                    currHeadNBV -= headDepr;
                }
            }

            // Tail Calculation
            let tailDisplay = 0, tailDepr = 0;
            if (!isNaN(tailYear) && year >= tailYear) {
                if (year === tailYear) {
                    tailDepr = tailCost * rate;
                    tailDisplay = tailCost;
                    currTailNBV = tailCost - tailDepr;
                } else {
                    tailDisplay = currTailNBV;
                    tailDepr = currTailNBV * rate;
                    currTailNBV -= tailDepr;
                }
            }

            let totalNBV = headDisplay + tailDisplay;
            let totalYearlyDepr = headDepr + tailDepr;
            let monthlyDepr = totalYearlyDepr / 12;

            if (year === currentYear) {
                currentYearHeadVal = headDisplay;
                currentYearTailVal = tailDisplay;
            }

            let rowClass = (year === currentYear) ? 'current-year-row' : '';
            
            tableHtml += `
                <tr class="${rowClass}">
                    <td>${year}</td>
                    <td>${formatRM(headDisplay)}</td>
                    <td>${formatRM(tailDisplay)}</td>
                    <td>${formatRM(totalNBV)}</td>
                    <td>${formatRM(totalYearlyDepr)}</td>
                    <td>${formatRM(monthlyDepr)}</td>
                </tr>
            `;
        }

        document.getElementById('tableBody').innerHTML = tableHtml;
        document.getElementById('head-current-val').innerText = "RM " + formatRM(currentYearHeadVal);
        document.getElementById('tail-current-val').innerText = "RM " + formatRM(currentYearTailVal);
    }

    function exportPDF() {
        const element = document.getElementById('report-container');
        
        // 1. åŠ ä¸Š PDF ä¸“ç”¨æ ·å¼ (å˜é»‘ç™½ï¼Œå®šå®½åº¦)
        element.classList.add('pdf-mode');

        const opt = {
            margin:       [10, 10, 10, 10], 
            filename:     'Truck_Depreciation_BW.pdf',
            image:        { type: 'jpeg', quality: 0.98 },
            html2canvas:  { 
                scale: 2, 
                useCORS: true,
            },
            jsPDF:        { unit: 'mm', format: 'a4', orientation: 'portrait' }
        };

        // 2. ç”Ÿæˆ
        html2pdf().set(opt).from(element).save().then(() => {
            // 3. æ¢å¤å½©è‰²
            element.classList.remove('pdf-mode');
        });
    }

    window.onload = calculate;
</script>

</body>
</html>
